<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversor de PDF para Texto</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="file-info.js"></script>
    <script src="atualizar.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="button-container">
        <button id="toggle-drop-zone">Mostrar/Ocultar Área de Solta</button>
        <button id="compare-tables">Comparar Tabelas</button>

    </div>
    <div id="drop-zone" style="display:flex;">Arraste e solte seu arquivo aqui</div>

    <div id="tables" style="display:none;">
        <div id="text-content"></div>
        <!-- Suas tabelas aqui -->
        <div style="height: 20px;"></div>
        <div>
        <h2 style="display: flex; justify-content: center;">Informações da compra</h2>
        </div>
        <table id="bancoDados">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Fornecedor</th>
                    <th>Id_compra</th>
                    <th>Quantidade</th>
                    <th>Valor Unitário</th>
                    <th>Valor Total</th>
                    <th>Qualidade</th>
                    <th>Medida</th>
                    <th>Tipo de Onda</th>
                    <th>Vincada</th>
                    <th>Status</th>
                    <th>Data_compra</th>
                    <th>Atualizar</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
        </table>
        <div style="height: 10px;"></div>
        <div>
        <h2 style="display: flex; justify-content: center;">Recebimento</h2>
    </div>
        <table id="recebimento">
            <thead>
                <tr>
                    <th>ID</th> <!-- Nova coluna ID adicionada aqui -->
                    <th>Fornecedor</th>
                    <th>Id_compra</th>
                    <th>Quantidade</th>
                    <th>Valor Unitário</th>
                    <th>Valor Total</th>
                    <th>Qualidade</th>
                    <th>Medida</th>
                    <th>Tipo de Onda</th>
                    <th>Vincada</th>
                    <th>Status</th>
                    <th>Data_recebimento</th>
                    <th>Atualizar</th>
                </tr>
            </thead>
            
            <tbody>
            </tbody>
        </table>
    </div>



    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        const dropZone = document.getElementById('drop-zone');

        dropZone.addEventListener('dragover', function(event) {
            event.stopPropagation();
            event.preventDefault();
            event.dataTransfer.dropEffect = 'copy';
        });

        dropZone.addEventListener('drop', function(event) {
            event.stopPropagation();
            event.preventDefault();
            const file = event.dataTransfer.files[0]; // Obtenha o primeiro arquivo que foi solto

            if (!file) {
                alert('Por favor, solte um arquivo válido.');
                return;
            }

            switch (file.type) {
                case 'application/pdf':
                    processPDF(file);
                    break;
                case 'text/xml':
                    processXML(file);
                    break;
                default:
                    alert('Formato de arquivo não suportado!');
                    break;
            }
        });

        function processPDF(file) {
            var reader = new FileReader();
            reader.onload = function(event) {
                var typedarray = new Uint8Array(event.target.result);
                extractText(typedarray);
            };
            reader.readAsArrayBuffer(file);
        }

        function processXML(file) {
            var reader = new FileReader();
            reader.onload = function(event) {
                var xml = event.target.result;
                parseXML(xml);

            };
            reader.readAsText(file);
        }


//criar tabelasconst tableb = document.getElementById('bancoDados').getElementsByTagName('tbody')[0];

function fetchChapas(xPed) {
    clearTable();  // Limpa as tabelas antes de buscar e adicionar novos dados
    axios.get(`http://localhost:5500/recebimento/${xPed}`)  // Altera o ID para puxar as chapas
        .then(response => {
            const data = response.data;
            if (data && data.length > 0) {
                data.forEach(chapa => {
                    const tableb = document.getElementById('bancoDados').getElementsByTagName('tbody')[0];
                    chapa.valor_unitario = data[0].valor_unitario;  // Copia o valor unitário da primeira chapa
                    chapa.quantidade_recebida = data[0].quantidade_comprada;  // Define a quantidade recebida para a quantidade comprada da primeira chapa
                    criarTable(tableb, chapa);
                });
            }
        })
        .catch(error => {
            var id_compra = xPed;
            var chapa = { id_compra };
            criarTable(tableBody, chapa);
            console.error('Erro ao buscar dados: ', error);
        });
}

function clearTable() {
    const tables = document.querySelectorAll('table');  // Seleciona todas as tabelas
    tables.forEach(table => {
        let tbody = table.getElementsByTagName('tbody')[0];
        while (tbody.firstChild) {
            tbody.removeChild(tbody.firstChild);  // Remove todas as linhas (children) do tbody
        }
    });
}



    
var rowId = 0;    // Variável global para manter o ID da linha
function criarTable(table, chapaData) {
    var row = table.insertRow(-1);

    // Criar a célula do ID com um campo de entrada para que seja editável
    var idCell = row.insertCell(0);
    idCell.innerHTML = `<input type='text' value='${chapaData.id_grupo_chapas ? chapaData.id_grupo_chapas : ''}' class='editable-id'>`; // Campo editável para ID



    var cellContents = [
        `<input type='text' value='${chapaData.fornecedor}'>`,
        `<input type='text' value='${chapaData.id_compra}'>`,
        `<input type='text' class='quantity' value='${chapaData.quantidade_recebida}' oninput='calculateTotal(this.parentNode.parentNode, chapaData)'>`,
        '<div class="currency-input"><input type="text" class="currency" value="' + parseFloat(chapaData.valor_unitario).toFixed(2) + '" oninput="calculateTotal(this.parentNode.parentNode)"></div>',
        '<div class="currency-input"><span class="currency-symbol"></span><p class="currency total">R$' + parseFloat(chapaData.valor_total).toFixed(2) + '</p></div>',
        `<input type='text' value='${chapaData.qualidade}'>`,
        `<input type='text' value='${chapaData.medida}'>`,
        `<select>${["E", "B", "C", "BB", "BC", ""].map(type => `<option value="${type}" ${type === chapaData.onda ? "selected" : ""}>${type}</option>`).join("")}</select>`,
        `<select><option value="">Vazio</option><option value="Sim" ${"Sim" === chapaData.vincos ? "selected" : ""}>Sim</option><option value="Não" ${"Não" === chapaData.vincos ? "selected" : ""}>Não</option></select>`,
        `<select style='width: 120px;'>${["Comprado", "Recebido", "Parcialmente", "Atrasado", "Cancelado"].map(status => `<option ${status === chapaData.status ? "selected" : ""}>${status}</option>`).join("")}</select>`,
        `<input type='date' value='${new Date().toISOString().slice(0, 10)}'>`,
        `<button class='update-button' onclick='sendDataToServer()'>Atualizar</button>`
    ];

    cellContents.forEach((content, index) => {
        var cell = row.insertCell(index + 1); // +1 para considerar a célula ID
        cell.innerHTML = content;
    });
}



document.getElementById('toggle-drop-zone').addEventListener('click', function() {
    var dropZone = document.getElementById('drop-zone');
    var tables = document.getElementById('tables');
    if (dropZone.style.display === 'none') {
        dropZone.style.display = 'flex';
        tables.style.display = 'none';
    } else {
        dropZone.style.display = 'none';
        tables.style.display = 'block';
    }
});


const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
            if (node.nodeType === 1) { // Verifica se o nó é do tipo Element
                // Aplica readonly aos inputs de texto e de data
                if (node.matches('#bancoDados input[type="text"], #bancoDados input[type="date"]')) {
                    node.setAttribute('readonly', 'true');
                }
                // Aplica disabled aos selects
                if (node.matches('#bancoDados select')) {
                    node.setAttribute('disabled', 'true');
                }
                // Verifica e modifica elementos filhos dentro de nó adicionado
                node.querySelectorAll('#bancoDados input[type="text"], #bancoDados input[type="date"], #bancoDados select').forEach(child => {
                    if (child.tagName === 'INPUT' && (child.type === 'text' || child.type === 'date')) {
                        child.setAttribute('readonly', 'true');
                    }
                    if (child.tagName === 'SELECT') {
                        child.setAttribute('disabled', 'true');
                    }
                });
            }
        });
    });
});

// Configura o observer para observar mudanças na árvore do DOM
observer.observe(document.body, {
    childList: true,
    subtree: true
});


document.getElementById('drop-zone').addEventListener('dragover', function(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'copy';
});

document.getElementById('drop-zone').addEventListener('drop', function(event) {
    event.preventDefault();
    const file = event.dataTransfer.files[0];
    if (file) {
        document.getElementById('drop-zone').style.display = 'none';
        document.getElementById('tables').style.display = 'block';
        // Processar o arquivo aqui
    } else {
        alert('Por favor, solte um arquivo válido.');
    }
});


document.getElementById('compare-tables').addEventListener('click', function() {
    const table1 = document.getElementById('bancoDados').getElementsByTagName('tbody')[0];
    const table2 = document.getElementById('recebimento').getElementsByTagName('tbody')[0];

    for (let i = 0; i < table2.rows.length; i++) {
        const row2 = table2.rows[i];
        let foundMatch = false; // Flag para indicar se uma correspondência foi encontrada

        outerLoop: // Label para o loop externo
        for (let j = 0; j < table1.rows.length; j++) {
            const row1 = table1.rows[j];
            let allMatch = true;

            for (let k = 1; k < row1.cells.length; k++) { // Começa de 1 para ignorar a primeira coluna
                if (k === 2) continue; // Pula a terceira coluna

                if (row2.cells.length <= k) { // Garante que não haverá erro se row2 tiver menos células
                    allMatch = false;
                    break;
                }

                let cell1 = row1.cells[k].querySelector('input, select') ? row1.cells[k].querySelector('input, select').value.trim().toLowerCase() : row1.cells[k].textContent.trim().toLowerCase();
                let cell2 = row2.cells[k].querySelector('input, select') ? row2.cells[k].querySelector('input, select').value.trim().toLowerCase() : row2.cells[k].textContent.trim().toLowerCase();

                if (cell1 !== cell2) {
                    allMatch = false;
                    break;
                }
            }

            if (allMatch) {
                const clonedRow = row1.cloneNode(true);
                // Modifica a décima primeira coluna para "recebido"
                if (clonedRow.cells.length > 10) {  // Certifica-se de que existe uma décima primeira coluna
                    const cell = clonedRow.cells[10];
                    if (cell.querySelector('input, select')) {
                        cell.querySelector('input, select').value = "Recebido";
                    } else {
                        cell.textContent = "Recebido";
                    }
                }
                table2.replaceChild(clonedRow, row2);
                foundMatch = true;
                break outerLoop; // Sai do loop assim que encontrar a primeira correspondência
            }
        }

        if (!foundMatch) {
            console.log('Nenhuma linha correspondente encontrada para a linha ' + (i + 1) + ' da tabela de baixo.');
        }
    }

    alert('Comparação e possível cópia de linhas concluídas.');
});




    </script>

</body>
</html>
